# 2025-12-09 作業レポート

## 実施概要
- 2ノード構成（prefill 192.168.110.13 / decode 192.168.110.97）での KV キャッシュ再利用検証スクリプトを強化。
- 公式ドキュメントの P2P 例に合わせ、プロンプトをフレーズ繰り返しで長文化し、chunk_size(256) 超を確実に。
- LMCache ログパーサを改善し、`LMCache hit tokens: None` を 0 と扱うなどロバスト化。
- 待機時間を 10 秒に設定し、P2P 転送の非同期遅延を考慮。
- Prefill → Decode の順で 2 回同一プロンプト送信、メトリクス/ログでヒット確認を行う流れを整理。

## 変更ファイル
- `verify_kv_cache_reuse_2node.py`
  - `LONG_PROMPT_MULTIPLIER` デフォルトを 20 に（環境変数で上書き可）。
  - `PROMPT_PHRASE` を公式例のフレーズに設定し、繰り返しで長文化（`BASE_PROMPT` を環境変数指定すればそれを優先）。
  - transformers が無い場合でも倍率指定で強制長文化。
  - ログパーサを拡張し `hit tokens: None` や `need to load` の負値を安全に処理。
  - 待機時間デフォルト 10 秒を維持し、P2P/非同期保存の遅延に備えた。
- （関連ドキュメント）`verify_kv_cache_reuse_2node_README.md` / `verify_kv_cache_reuse_README.md` を参照。

## これまでの挙動・判明事項
- 短いプロンプト（<256 tokens）では外部プレフィックスキャッシュ対象外となりヒットしない。
- `Got layout info from controller: ('', '', 0, '')` が出る場合、レイアウト未確立で P2P 転送されない。
- 17:01 頃の長文リクエストでは Decode 側で `hit tokens: 256` を取得し、Prefill -> P2P -> Decode の転送が成立したことを確認。
- その後のリクエストでレイアウトが空のままの場合は、起動順や登録重複（already registered）、Controller 再起動が必要。

## 再現・実行手順（推奨）
1. 起動順: Controller → Prefill(example1.yaml) → Decode(example2.yml)。登録重複が出ないクリーン状態にする。
2. 環境変数（例）:
   - `export LONG_PROMPT_MULTIPLIER=20`
   - （必要なら）`export WAIT_TIME_BETWEEN_REQUESTS=10.0`
3. 実行: `python3 verify_kv_cache_reuse_2node.py`
4. Decode 側ログで確認:
   - `Got layout info ...` が Prefill 側 LocalCPUBackend を指すこと。
   - `LMCache hit tokens: X (X>0)` が出ること。

## 残課題
- レイアウトが空のままになるケースがあるため、Controller 再起動と起動順の徹底が必要。
- Decode 側で自前保存が走るケースがある（Prefill → P2P 経路が確立していないとき）。継続的にログでの確認が必要。

## 参考
- 公式ドキュメント「Example: Share KV cache across multiple LLMs」の P2P 例をベースに設定（ポート/instance_id は example1.yaml / example2.yml に準拠）。
- 長文プロンプトの生成は `PROMPT_PHRASE` 繰り返し方式で簡素化。


